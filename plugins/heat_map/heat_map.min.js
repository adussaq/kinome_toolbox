!function(){"use strict";var e,a=[require("bs_toggle-js"),require("img-picker"),require("gradient"),require("hcluster"),require("d3")];require("bs_toggle-css","style"),e=function(e,a){var r,l,s,d,u,m,h,g,f,v,k={},y={linear:{},kinetic:{}},b={},x={linear:2,kinetic:2};k.div=e,b.linear={param:0,params:a[0].linear.equation.mathParams},b.kinetic={param:0,params:a[0].kinetic.equation.mathParams},k.width=$("<div>",{class:"col col-sm-6 col-xs-12"}),k.width.appendTo($("<div>",{class:"row"}).appendTo($("<div>",{class:"container",style:"height:0px;visibility: hidden;"}).appendTo("body"))),s=function(e,a){return e?e.signal.parameters[b[a].param]:NaN},d=function(e,a){return e?e.background.parameters[b[a].param]:NaN},m=function(e,t){if(!e)return NaN;var r,n,i,o,l,p=[];if("kinetic"===t?(i=e.exposure,o={type:t,exposure:e.exposure}):(i=e.cycle,o={type:t,cycle:e.cycle}),y[t][b[t].param]=y[t][b[t].param]||{},void 0!==y[t][b[t].param][i])l=y[t][b[t].param][i];else{for(r=a.get(o),n=0;n<r.length;n+=1)p.push(r[n].signal.parameters[b[t].param]-r[n].background.parameters[b[t].param]);l=(p=p.sort(function(e,a){return e-a}))[Math.floor(p.length/20)-1],y[t][b[t].param][i]=l}return e.signal.parameters[b[t].param]-e.background.parameters[b[t].param]<l?0:Math.log(e.signal.parameters[b[t].param]-e.background.parameters[b[t].param]-l+1)/Math.log(2)},l={kinetic:u=function(e,a){return e?Math.log(e.signal.parameters[b[a].param]/e.background.parameters[b[a].param])/Math.log(2):NaN},linear:u},f=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},h=function(e){g=e;var r,s,d,u;k&&k.heatMaps&&(k.linearHeatMap.empty(),k.kineticHeatMap.empty()),r=t(a,l,"linear",e),s=t(a,l,"kinetic",e),d=o(n(i(r))),u=o(n(i(s))),void 0!==k.dummyHeatMap&&($("<h3>Linear Heat Map</h3>").appendTo(k.linearHeatMap),p(d,a,k.dummyHeatMap).css({"margin-bottom":"10px"}).appendTo(k.linearHeatMap),c(d,k.dummyHeatMap).css({width:"100%"}).appendTo(k.linearHeatMap),$("<h3>Kinetic Heat Map</h3>").appendTo(k.kineticHeatMap),p(u,a,k.dummyHeatMap).css({"margin-bottom":"10px"}).appendTo(k.kineticHeatMap),c(u,k.dummyHeatMap).css({width:"100%"}).appendTo(k.kineticHeatMap))},k.figures=$("<div>",{class:"row"}),k.linear={},k.kinetic={},r=function(e){var t,r=k[e];for(r.col=$("<div>",{class:"col col-xs-12 col-sm-6"}),r.title=$("<h3>"+f(e)+" Options</h3>"),r.equationTitle=$("<h4>Model Parameterized</h4>"),r.equation=$("<div>",{style:"min-height: 40px;display: table;"}).append($("<div>",{style:"display: table-cell;vertical-align:middle;"}).append(M.sToMathE(a[0][e].equation.mathType))),r.parameterTitle=$("<h4>Parameter Viewing</h4>"),r.parameterPicker=$("<select>",{style:"vertical-align: middle",class:"form-control"}),r.backCorrTitle=$("<h4>Background Correction</h4>"),r.backCorrPicker=$("<select>",{style:"vertical-align: middle",class:"form-control"}),r.backCorrSelected=$("<div>",{style:"margin-top:15px;",class:"text-center"}),r.fig=$("<div>"),r.f_val=$("<p>",{class:"text-center lead"}),r.col.append(r.title).append(r.equationTitle).append(r.equation).append(r.parameterTitle).append(r.parameterPicker).append(r.backCorrTitle).append(r.backCorrPicker).append(r.backCorrSelected).append(r.fig).append(r.f_val),t=0;t<b[e].params.length;t+=1)r.parameterPicker.append('<option value="'+t+'">'+b[e].params[t]+"</option>");r.parameterPicker.change(function(a){var t=a.target.value;b[e].param=t,h(g)}),r.backCorrPicker.append('<option value="0">Signal</option><option value="1">Background</option><option selected value="2">log_2(s/b)</option><option value="3">log_2(100(s - b + c_e))</option>').change(function(a){var t,n,i=a.target.value;switch(x[e]=i,i){case"0":r.backCorrSelected.html("signal"),l[e]=s;break;case"1":r.backCorrSelected.html("background"),l[e]=d;break;case"2":r.backCorrSelected.html(M.sToMathE("log_2({signal}/{background})")),l[e]=u;break;case"3":r.backCorrSelected.html(M.sToMathE("log_2{100(signal-background+c_e)}")),l[e]=m}h(g),"3"===i&&(t="kinetic"===e?g.exposure:g.cycle,n=1-y[e][b[e].param][t],r.backCorrSelected.append(",&nbsp;&nbsp;").append(M.sToMathE("c_e="+n.toFixed(4))))}),r.backCorrSelected.html(M.sToMathE("log_2({signal}/{background})"))},(v=KINOME.imagePicker(a)).div.appendTo(e),v.change(h),v.disableSample(),r("linear"),r("kinetic"),k.figures.append(k.linear.col).append(k.kinetic.col),k.heatMaps=$("<div>",{class:"row"}),k.linearHeatMap=$("<div>",{class:"col-sm-6"}).appendTo(k.heatMaps),k.kineticHeatMap=$("<div>",{class:"col-sm-6"}).appendTo(k.heatMaps),k.dummyHeatMap=$("<div>",{class:"col-sm-6"}).appendTo($("<div>",{class:"row"}).appendTo($("<div>",{style:"height: 0px; visibility: hidden;",class:"container"}).appendTo("body"))),k.div.append(k.title).append(k.figures).append(k.heatMaps),h(g);var T=function(){var e={};return function(a,t,r){r||(r="Don't call this twice without a uniqueId"),e[r]&&clearTimeout(e[r]),e[r]=setTimeout(a,t)}}();window.addEventListener("resize",function(){T(function(){h(g)},500,"resize_reproduce")})};var t=function(e,a,t,r){var n=[],i=e.list("peptides"),o={type:t};"linear"===t?o.cycle=r.cycle:"kinetic"===t&&(o.exposure=r.exposure);for(var l=0;l<e.length;l++){n[l]=[];for(var p=0;p<i.length;p++)o.peptides=i[p],n[l].push(a[t](e[l].get(o)[0],t))}return n},r=function(e){return e[0].map(function(a,t){return e.map(function(e){return e[t]})})},n=function(e){return e.left?n(e.left).concat(n(e.right)):[e.value]},i=function(e){var a,t,i;return a=r(e),t=KINOME.hcluster(a,"euclidean","average"),i=r(n(t)),KINOME.hcluster(i,"euclidean","average")},o=function(e){for(var a=-1/0,t=1/0,r=0;r<e.length;r++)for(n=0;n<e[r].length;n++)isNaN(e[r][n])||(a=Math.max(e[r][n],a),t=Math.min(e[r][n],t));for(r=0;r<e.length;r++)for(var n=0;n<e[r].length;n++)e[r][n]=(e[r][n]-t)/(a-t);return e},l=function(e,a){return e.left?{children:[l(e.left,a),l(e.right,a)]}:{name:"G"+a[e.key].group,samp:"S"+e.key}},p=function(e,a,t){var r,n=$("<div>");p=i(e),r=l(p,a);var o=t.width(),p=d3.layout.cluster().size([o-10,110]),c=d3.select(n[0]).append("svg").attr("width",o).attr("height",180).append("g").attr("transform","translate(5,40)"),s=p.nodes(r),d=(c.selectAll(".link").data(p.links(s)).enter().append("path").attr("class","link").attr("d",function(e,a){return"M"+e.source.x+","+e.source.y+"H"+e.target.x+"V"+e.target.y}),c.selectAll(".node").data(s).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}));return d.append("circle").attr("r",4.5),d.append("text").attr("dy",17).attr("dx",-7).attr("text-anchor",function(e){return e.children?"end":"start"}).text(function(e){return e.name}),d.append("text").attr("dy",30).attr("dx",-7).attr("text-anchor",function(e){return e.children?"end":"start"}).text(function(e){return e.samp}),$("head").append("<style>.node circle {fill: #fff;stroke: steelblue;  stroke-width: 1.5px;} .node {  font: 10px sans-serif;} .link {  fill: none;  stroke: #ccc;  stroke-width: 1.5px;}</style>"),n},c=function(e,a){var t,r,n=document.createElement("canvas"),i=e[0].length,o=e.length;n.width=a.width(),n.height=4*i,r=n.width/o,t=n.getContext("2d");for(var l=0;l<e.length;l++)for(var p=0;p<e[l].length;p++)t.fillStyle=KINOME.gradient.convert(e[l][p]),t.fillRect(l*r,4*p,r,4);return $(n)};Promise.all(a).then(function(){var a=KINOME.addAnalysis("Heat Map");e(a,KINOME.get({level:"^2"}))})}("undefined"!=typeof module&&module.exports?module.exports:window);