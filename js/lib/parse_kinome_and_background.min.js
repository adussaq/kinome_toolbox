!function(){"use strict";var e,t,a,n,r,l,i,s,u,o,p,c,d,h;l=function(e){return function(t){return[p(t[e])]}},c=function(){var e,t;for(e=1,t="";e<37;)t+=51*e&52?(15^e?8^Math.random()*(20^e?16:4):4).toString(16):"-",e+=1;return t},s=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)?e:null},h=function(e){return"string"==typeof e&&e.match(/^NA$|^NAN$/i)?NaN:e},p=function(e){return"object"==typeof e?JSON.parse(JSON.stringify(e)):e},i=function(e){var t;return e=e.map(h),t=e.reduce(s),null!==t?t:e},t=function(e){return e.split("\t")},a=function(e,t){var a,o,d,h,g,f,m,y,v,k,_,b,x,N,w,O,$;a=e.shift().join(";"),o=[],g=[],f={};do{o.push(e.shift())}while(!e[0][0]);for(v=e.shift(),_=(d=r(e,v)).data,k=d.peptides,h=n(o),m=0;m<h[0].length;m+=1)h[0][m].key.match(/^barcode$/i)&&(b=m),h[0][m].key.match(/^row$/i)&&(x=m);for(m=0;m<h.length;m+=1)if(N=h[m][b].value[0]+"_"+h[m][x].value[0],f.hasOwnProperty(N)){for(w=0;w<h[m].length;w+=1)f[N].meta[w].value=f[N].meta[w].value.concat(p(h[m][w].value));for(w=0;w<_.length;w+=1)f[N].data[w].push(p(_[w][m]))}else f[N]={peptides:p(k),name:N,name_id:c(),meta:h[m],data:_.map(l(m))};for(O=Object.keys(f),m=0;m<O.length;m+=1){for(y=f[O[m]],w=0;w<y.meta.length;w+=1)y.meta[w].value=i(y.meta[w].value),(null===y.meta[w].value||"number"==typeof y.meta[w].value&&isNaN(y.meta[w].value))&&(y.meta.splice(w,1),w-=1);for(y.meta.push({key:"filename",value:t}),y.meta.push({key:"title line",value:a}),w=0;w<y.meta.length;w+=1)y.meta[w].key.match(/^cycle$/i)&&(y.cycles=p(y.meta[w].value.map(u))),y.meta[w].key.match(/^exposure[\s_]*time$/i)&&(y.exposures=p(y.meta[w].value.map(u)));for(w=0;w<y.data.length;w+=1)$=y.data[w].reduce(s),isNaN($)&&(y.data.splice(w,1),y.peptides.splice(w,1),w-=1);g.push(y)}return g},n=function(e){var t,a,n,r,l;for(t=[],l=[],n=0;n<e.length;n+=1){for(;!e[n][0];)e[n].shift();l.push(e[n].shift())}for(n=0;n<e[0].length;n+=1){for(a=[],r=0;r<l.length;r+=1)a.push({key:l[r],value:[e[r][n]]});t.push(a)}return t},r=function(e,t){var a,n,r,l;for(r={peptides:[],data:[]},a=0;a<e.length;a+=1){for(l=[],n=0;e[a][0];)l.push({key:t[n],value:e[a].shift()}),n+=1;for(r.peptides.push(l);!e[a][0];)e[a].shift();r.data.push(e[a].map(u))}return r},e=function(e){var n,r,l,i,s,u;if(n=e.signal.data.split(/\r*\n\r*/).map(t),l=e.background.data.split(/\r*\n\r*/).map(t),r=a(n,e.signal.filename),i=a(l,e.background.filename),!(s=o(r,i)))throw"failed to combine files, make sure all meta data is included and the files were exported at the same time with seperate data.";return(u=p(s)).map(function(e){return e.level="name",delete e.signal,delete e.background,delete e.signal_valid,delete e.background_valid,e}),s.map(function(e){return e.level="1.0.0",e}),{name:u,"1.0.0":s}},o=function(e,t){var a,n,r,l=[];r=function(e,t){for(var a,n,r,l,i=!0,s=[[e,t]];i&&s.length;)if(typeof(a=s.shift())[0]!=typeof a[1]&&(i=!1),"object"!=typeof a[0])a[0]!==a[1]&&(i=!1);else if(n=Object.keys(a[0]).sort(),r=Object.keys(a[1]).sort(),n.length!==r.length)i=!1;else for(l=0;l<n.length;l+=1)n[l]===r[l]?s.push([a[0][n[l]],a[1][r[l]]]):i=!1;return i},a=function(e,t){var a,l,i,s,u,o,p={},c=!0,h=[];for(p.meta=n(e.meta,t.meta),p.name=e.name,p.name_id=e.name_id,(p=d(p)).exposures=[],p.cycles=[],p.peptides=[],p.signal=[],p.background=[],p.signal_valid=[],p.background_valid=[],i=function(e,t){return e.key-t.key},e.exposures.length===t.exposures.length&&e.cycles.length===t.cycles.length&&e.exposures.length===t.cycles.length&&e.peptides.length===t.peptides.length&&e.data.length===t.data.length&&e.data.length===t.peptides.length&&e.data[0].length===t.data[0].length&&e.data[0].length===t.cycles.length||(c=!1),a=0;c&&a<e.exposures.length;a+=1)for(c=!1,l=0;!c&&l<t.exposures.length;l+=1)e.exposures[a]===t.exposures[l]&&e.cycles[a]===t.cycles[l]&&(c=!0,p.exposures.push(e.exposures[a]),p.cycles.push(e.cycles[a]),h.push({fore:a,back:l}));for(a=0;c&&a<e.peptides.length;a+=1)for(c=!1,l=0;!c&&l<t.peptides.length;l+=1)if(r(e.peptides[a].sort(i),t.peptides[l].sort(i)))for(c=!0,p.peptides.push(e.peptides[a]),s=p.peptides.length-1,o=0;o<h.length;o+=1)p.signal[o]=p.signal[o]||[],p.background[o]=p.background[o]||[],p.signal_valid[o]=p.signal_valid[o]||[],p.background_valid[o]=p.background_valid[o]||[],p.signal[o][s]=e.data[a][h[o].fore],p.background[o][s]=t.data[l][h[o].back],p.signal_valid[o][s]=0,p.background_valid[o][s]=0,p.signal[o][s]<4095&&(p.signal_valid[o][s]=1),p.background[o][s]<4095&&(p.background_valid[o][s]=1);return u=Math.max.apply(null,p.cycles),p.cycles=p.cycles.map(function(e){return e===u?null:e}),c||(p=!1),p},n=function(e,t){var a,n,l,i=[],s=[];for(a=0;a<e.length;a+=1){for(l=!1,n=0;!l&&n<t.length;n+=1)e[a].key===t[n].key&&(l=!0,s[n]=!0,r(e[a],t[n])?i.push(e[a]):(e[a].origin="signal",t[n].origin="background",i.push(e[a]),i.push(t[n])));l||(e[a].origin="signal",i.push(e[a]))}for(a=0;a<t.length;a+=1)s[a]||(t[a].origin="signal",i.push(t[a]));return i};var i,s,u,o=!0;for(i=0;o&&i<e.length;i+=1)for(o=!1,s=0;!o&&s<t.length;s+=1)e[i].name===t[s].name&&(u=a(e[i],t[s]))&&(o=!0,l.push(u));return o||(l=!1),l},u=function(e){return 1*e},d=function(e){var t,a,n,r,l=[],i=[];for(t=(t=["barcode","row","col","filter","image","temperature","instrument_type","instrument_unit","image_timestamp","lamp_power","lamp_refrence_power","pamchip_location","array","runData","gridid","grid_type","article_number","exposure_time","cycle","title_line","filename"]).map(function(e){return new RegExp("^"+e+"$","i")}),a=0;a<e.meta.length;a+=1){for(r=!1,n=0;!r&&n<t.length;n+=1)e.meta[a].key.replace(/\s+/g,"_").match(t[n])&&(l.push(p(e.meta[a])),r=!0);r||i.push(p(e.meta[a]))}return delete e.meta,e.sample_data=i,e.run_data=l,e},exports.parse=e}("undefined"!=typeof module&&module.exports?module.exports:KINOME);