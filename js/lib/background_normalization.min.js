!function(e){"use strict";var n,t,r,o=require("fit");o.hasOwnProperty("fit")?o=o.fit:o.then(function(){o=KINOME.fit});var a=function(){var e={};return function(n,t,r,a){var i="linear"===t?n[0].name+n[0].cycle+n[0].peptide+r:n[0].name+n[0].exposure+n[0].peptide+r;return e[i]||(e[i]=o(n,t,r).then(function(e){var n={};return n[r]={R2:e[r].R2,parameters:e[r].parameters},n.equation={func:e.equation.func},n})),e[i].then(function(e){return e.passback=a,e})}}(),i=function(e,n,t,r){var o,i,u=[],c=t.cycle,s=t.peptide,l=t.exposure;for(i=0,o=0;o<e.length;o+=1)i+=1*e[o][r+"_valid"];for(u[0]=i>1?a(e,"linear",r,l).then(function(e){return{R2:e[r].R2,val:e.equation.func([e.passback],e[r].parameters,e.equation.func([e.passback],e[r].parameters))}}):Promise.resolve({R2:0,val:0}),e=[],i=0,o=0;o<n.length;o+=1)i+=1*n[o][r+"_valid"];return u[1]=i>5?a(n,"kinetic",r,c).then(function(e){return{R2:e[r].R2,val:e.equation.func([e.passback],e[r].parameters),passback:e.passback,peptide:s}}):Promise.resolve({R2:0,val:0,peptide:s,cycle:c,exposure:l}),n=[],Promise.all(u).then(function(e){var n=0,t=0;return e[0].R2>.8&&!Number.isNaN(e[0].val)&&(n+=e[0].val*e[0].R2,t+=e[0].R2),e[1].R2>.8&&!Number.isNaN(e[1].val)&&(n+=e[1].val*e[1].R2,t+=e[1].R2),t>0&&(n/=t),n&&n<5500&&n>0?n:NaN})},u=function(e){var n,t,r=e[0],o=e[1],a=e[2];return n=r.spot_row-1,t=r.spot_col-1,{x:n,y:t,signal:a,background:o,name:r.peptide,cycle:r.cycle,exposure:r.exposure}};r=function(e,n){return function(t){if(!t.get||"function"!=typeof t.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";if("1.0.1"!==t.level)throw"This is designed only for level 1.0.1 data. You passed in level: "+t.level;var r,o,a,c,s,l,d,p,g,f=[],m=t.clone();m.level="1.1.2",o=m.list("cycles"),a=m.list("exposures"),c=function(e){var t,r=0;for(r=0;r<e.backgrounds.length;r+=1)(t=m.get({cycle:e.cycle,exposure:e.exposure,peptide:e.backgrounds[r].peptide})[0]).background_valid&&t.set("background",e.backgrounds[r].background);n.done+=1,n.done=Math.floor(n.done)};var h=function(e){var n={background:[],signal:[],name:[]};return e.map(function(e){n.background[e.x]=n.background[e.x]||[],n.signal[e.x]=n.signal[e.x]||[],n.name[e.x]=n.name[e.x]||[],n.cycle=e.cycle,n.exposure=e.exposure,n.background[e.x][e.y]=e.background,n.signal[e.x][e.y]=e.signal,n.name[e.x][e.y]=e.name}),n},b=function(n){if(n.background.length&&n.background[0].length)return e.submit(n).then(c)};for(s=0;s<o.length;s+=1)for(l=0;l<a.length;l+=1){for(r=m.get({cycle:o[s],exposure:a[l]}),g=[],d=0;d<r.length;d+=1)p=[Promise.resolve(r[d])],r[d].background_valid?p[1]=Promise.resolve(r[d].background):p[1]=i(t.get({cycle:r[d].cycle,peptide:r[d].peptide}),t.get({exposure:r[d].exposure,peptide:r[d].peptide}),r[d],"background"),r[d].signal_valid?p[2]=Promise.resolve(r[d].signal):p[2]=i(t.get({cycle:r[d].cycle,peptide:r[d].peptide}),t.get({exposure:r[d].exposure,peptide:r[d].peptide}),r[d],"signal"),g.push(Promise.all(p).then(u));g.length&&(console.log("Starting one pic analysis"),n.total+=1),f.push(Promise.all(g).then(h).then(b))}return Promise.all(f).then(function(){return m})}},t=function(e){var n,t,r,o,a,i,u,c=e.list("exposures");for(r=function(e){var n=1/0;return e.background_valid&&(n=Math.min(n,e.background)),e.signal_valid&&(n=Math.min(n,e.signal)),n},o=function(e,n){return"number"==typeof e&&"number"==typeof n?Math.min(e,n):"number"==typeof e?e:"number"==typeof n?n:1/0},i=e.list("cycles").reduce(o),n=0;n<c.length;n+=1)if((u=e.get({cycle:i,exposure:c[n]})).length>1)for(a=u.map(r).reduce(o),u=e.get({exposure:c[n]}),t=0;t<u.length;t+=1)u[t].set("signal",u[t].signal-a),u[t].set("background",u[t].background-a);return e},n=function(e){return new Promise(function(n,o){e.data&&"object"==typeof e.data||o("Data object not added in. This will not work without it."),e.amd_ww&&"object"==typeof e.amd_ww||o("AMD_WW object not added in. This will not work without it."),e.worker&&"string"==typeof e.worker||o("String for worker url not added in. This will not work without it."),Array.isArray(e.data)||(e.data=[e.data]);var a,i,u={total:0,done:0};i=e.number_threads||void 0,a=e.amd_ww.start({filename:e.worker,num_workers:i}),console.log("\nStarting fits for background normalization.\n"),Promise.all(e.data.map(r(a,u))).catch(function(e){o({message:"Background normalization failed:",error:e})}).then(function(e){e=e.map(t),n(e)}).catch(function(e){o(e)}),e.hasOwnProperty("update")&&"function"==typeof e.update&&e.update(u)})},e.normalize_background=n}("undefined"!=typeof module&&module.exports?module.exports:KINOME);