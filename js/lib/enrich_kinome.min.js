!function(e){"use strict";e.enrich=function(r){var t,n,l,s,o,a,i,p,c,u,y,d,h,g,f,v,m,b,O,P,w,x,k;return g=function(){var r,a,i,g;t=function(e){var t,n,l,s,o,p,u,d,h=[],g=this;for(s=(e=w(e)).peptides,p=e.exposures,o=e.cycles,t=0;t<s.length;t+=1)for(n=0;n<o.length;n+=1)for(l=0;l<p.length;l+=1)u=c[o[n]][p[l]],d=y[s[t]].index,void 0!==u&&void 0!==d&&h.push({peptide:s[t],cycle:o[n],exposure:p[l],signal:g.signal[u][d],signal_valid:g.signal_valid[u][d],background:g.background[u][d],background_valid:g.background_valid[u][d],spot_row:1*y[s[t]].row,spot_col:1*y[s[t]].col,image:i(u,g),set:r(u,d,g),more:a(u,y[s[t]])});return h},a=function(e,r){return function(){return{peptide:v(r),image_index:e}}},i=function(e,r){var t;for(t=0;t<r.run_data.length;t+=1)if(r.run_data[t].key.match(/image/i))return r.run_data[t].value[e]},s=function(e){var r,t,n,s,o,a,i,p,c=this;if(g(e)){if(r=e.value,t=e.valid,n=e.type,s=e.peptide,a=e.cycle,o=e.exposure,o=null===o?"Cycle Slope":o,a=null===a?"Post Wash":a,1!==(p=c.get({peptide:s,cycle:a,exposure:o})).length){for(c.signal.push(b(c[n][0].length)),c.signal_valid.push(b(c[n][0].length)),c.background.push(b(c[n][0].length)),c.background_valid.push(b(c[n][0].length)),c.cycles.push("string"==typeof a?null:a),c.exposures.push("string"==typeof o?null:o),i=0;i<c.run_data.length;i+=1)Array.isArray(c.run_data[i].value)&&c.run_data[i].value.length===c.cycles.length-1&&c.run_data[i].value.push(void 0);l(c),p=c.get({peptide:s,cycle:a,exposure:o})}return p[0].set(n,r),p[0].set(n+"_valid",t),!0}return console.error("Failed to set, one or more parameters were missing or invalid."),!1},g=function(e){var r=!1;return e&&e.hasOwnProperty("value")&&e.hasOwnProperty("valid")&&e.hasOwnProperty("type")&&e.hasOwnProperty("peptide")&&e.hasOwnProperty("cycle")&&e.hasOwnProperty("exposure")&&(e.value*=1,e.valid*=1,e.cycle=null===e.cycle?null:"Post Wash"===e.cycle?null:1*e.cycle,e.exposure=null===e.exposure?null:"Cycle Slope"===e.exposure?null:1*e.exposure,isNaN(e.value)||isNaN(e.valid)||isNaN(e.cycle)||isNaN(e.exposure)||"string"!=typeof e.type||"string"!=typeof e.peptide||y.hasOwnProperty(e.peptide)&&e.type.match(/background|signal/)&&(r=!0)),r},r=function(e,r,t){return function(n,l){var s=this;n.match(/^(signal|background)(_valid)*$/)&&(t[n][e][r]=l,s[n]=l)}},n=function(e){var r;return"string"!=typeof(e=e||"")&&(e="",console.warn("list should only be passed a string")),e.match(/peptide/i)?(r=v(u),r.more=O,r):e.match(/exposure/i)?v(d):e.match(/cycle/i)?v(p):(r={peptides:v(u),exposures:v(d),cycles:v(p)},r.peptides.more=O,r)},l=function(e){var r,t,n;for(p=[],c={},d=[],h={},u=[],y={},P(e),r=0;r<e.cycles.length;r+=1)null===(t=e.cycles[r])&&(t="Post Wash"),null===(n=e.exposures[r])&&(n="Cycle Slope"),c[t]=c[t]||[],c[t][n]=r,h[n]=1;p=Object.keys(c).map(m),d=Object.keys(h).map(m)},o=function(r){var t,n,l,s=this;for(l=(n=JSON.parse(s.stringify())).cycles.length,delete n.cycles,delete n.exposures,delete n.background,delete n.background_valid,delete n.signal,delete n.signal_valid,delete n._id,"string"!=typeof r&&console.error("No equation string passed in, please pass in a string with the needed parts. Example: https://github.com/adussaq/kinome_toolbox/blob/master/models/cyclingEq_3p_hyperbolic.jseq"),n.linear={signal:[],background:[],cycles:[]},n.kinetic={signal:[],background:[],exposures:[],equation_string:r},n.level=n.level.replace(/^1/,"2"),console.warn("delete this part once updated the data struct"),t=0;t<n.run_data.length;t+=1)if(n.run_data[t].key.match(/^cycle$/i)){l=n.run_data[t].value.length;break}for(t=0;t<n.run_data.length;t+=1)n.run_data[t].value.length===l&&(n.run_data.splice(t,1),t-=1);for(t=0;t<n.sample_data.length;t+=1)n.sample_data[t].value.length===l&&(n.sample_data.splice(t,1),t-=1);return e.enrich(n)}},f=function(){var e,r,o,a=["kinetic","linear"];s=function(e){var t,n,s,o,a,i,p,c=this;return r(e)?(t=e.value,n=e.peptide,o=e.cycle,s=e.exposure,i=e.type,p=e.signal_type,1!==(a=c.get({peptide:n,type:i,cycle:o,exposure:s})).length&&("kinetic"===i?(c.kinetic.signal.push(b(c.peptides.length)),c.kinetic.background.push(b(c.peptides.length)),c.kinetic.exposures.push("string"==typeof s?null:s)):"linear"===i&&(c.linear.signal.push(b(c.peptides.length)),c.linear.background.push(b(c.peptides.length)),c.linear.cycles.push("string"==typeof o?null:o)),l(c),a=c.get({peptide:n,type:i,cycle:o,exposure:s})),a[0].set(p,t),!0):(console.error("Failed to set, one or more parameters were missing or invalid."),!1)},e=function(e,r,t,n){return function(l,s){var o=this;"string"==typeof l&&(l=l.toLowerCase()).match(/^signal$|^background$/)?(n[e][l][r][t]=s,o[l]=s):console.error("failed to set, key invalid")}},o=function(e,r){return function(){return{peptide:v(r),fit_index:e}}},t=function(r){var t,n,l,s,i,p,u,d,g,f,m,b,O,P,x=this,k={},_=[];for(t=(r=w(r)).peptides,l=r.exposures,n=r.cycles,"string"==typeof(s=r.hasOwnProperty("type")?r.type:r.hasOwnProperty("types")?r.types:a)&&s.match(/kinetic|linear/i)?s=[s.toLowerCase()]:Array.isArray(s)&&s.map(function(e,r){return s[r]=s[r].toLowerCase(),e.match(/kinetic|linear/)?1:0}).reduce(function(e,r){return e*r})||(s=a),i=0;i<s.length;i+=1)for("kinetic"===s[i]?(d=l,f=h,g="exposure",m="cycle",b=n):(d=n,f=c,g="cycle",m="exposure",b=l),p=0;p<d.length;p+=1)for(u=0;u<t.length;u+=1)O=f[d[p]],P=y[t[u]].index,(k={peptide:t[u],type:s[i],signal:x[s[i]].signal[O][P],background:x[s[i]].background[O][P],spot_row:1*y[t[u]].row,spot_col:1*y[t[u]].col,set:e(s[i],O,P,x),more:o(O,y[t[u]])})[g]=d[p],k[m]=v(b),_.push(k);return _},l=function(e){var r,t,n;for(p=[],c={},d=[],h={},u=[],y={},P(e),r=0;r<e.linear.cycles.length;r+=1)null===(t=e.linear.cycles[r])&&(t="Post Wash"),c[t]=r;for(r=0;r<e.kinetic.exposures.length;r+=1)null===(n=e.kinetic.exposures[r])&&(n="Cycle Slope"),h[n]=r;p=Object.keys(c).map(m),d=Object.keys(h).map(m)},r=function(e){var r,t,n=!1;return e=e||{},e.exposure=null===e.exposure?"Cycle Slope":e.exposure,e.cycle=null===e.cycle?"Post Wash":e.cycle,e.hasOwnProperty("signal")&&!e.hasOwnProperty("background")?(r=e.signal,t="signal"):!e.hasOwnProperty("signal")&&e.hasOwnProperty("background")&&(r=e.background,t="background"),t&&"string"==typeof e.type&&e.type.match(/^linear$|^kinetic$/)&&"string"==typeof e.peptide&&y.hasOwnProperty(e.peptide)&&("linear"!==e.type||"number"!=typeof e.cycle&&"Post Wash"!==e.cycle?"number"!=typeof e.exposure&&"Cycle Slope"!==e.exposure||(n=!0):n=!0),e.signal_type=t,e.value=r,n},n=function(e){var r;return"string"!=typeof(e=e||"")&&(e="",console.warn("list should only be passed a string")),e.match(/peptide/i)?(r=v(u),r.more=O,r):e.match(/exposure/i)?v(d):e.match(/cycle/i)?v(p):e.match(/type/i)?v(a):(r={peptides:v(u),exposures:v(d),cycles:v(p),types:v(a)},r.peptides.more=O,r)}},x=function(){var e,r,s;s=function(e,r){var t,n={};for(t=0;t<e.length;t+=1)n[e[t]]=1;for(t=0;t<r.length;t+=1)n[r[t]]=1;return Object.keys(n)},l=function(e){var t,n,l,o={},a={},i={},p={};r={},e.map(function(e){for(n=e.list(),l=Object.keys(n),t=0;t<l.length;t+=1)r.hasOwnProperty(l[t])?s(r[l[t]],n[l[t]]):r[l[t]]=n[l[t]];o[e.group]=1,a[e.name]=1,i[e.name_id]=1,p[e.level]=1}),r.cycles=r.cycles.map(m),r.exposures=r.exposures.map(m),r.groups=Object.keys(o).map(m),r.names=Object.keys(a),r.ids=Object.keys(i),r.levels=Object.keys(p)},t=function(r){var t,n=this,l=[];for(r=e(r),t=0;t<n.length;t+=1)n[t].name.match(r.names)&&n[t].group.toString().match(r.groups)&&n[t].level.match(r.levels)&&n[t].name_id.match(r.ids)&&(l=l.concat(n[t].get(r)));return l},n=function(e){"string"!=typeof(e=e||"")&&(e="",console.warn("list should only be passed a string"));var t,n=Object.keys(r);for(t=0;t<n.length;t+=1)if(e.match(new RegExp(n[t],"i")))return v(r[n[t]]);return v(r)},e=function(e){var t,n,l,s,o;return t=e.hasOwnProperty("groups")?e.groups:e.hasOwnProperty("group")?e.group:r.groups,Array.isArray(t)||(t=[t]),t=new RegExp("^"+t.join("$|^")+"$","i"),n=e.hasOwnProperty("names")?e.names:e.hasOwnProperty("name")?e.name:r.names,Array.isArray(n)||(n=[n]),n=new RegExp("^"+n.join("$|^")+"$","i"),l=e.hasOwnProperty("ids")?e.ids:e.hasOwnProperty("id")?e.id:r.ids,Array.isArray(l)||(l=[l]),l=new RegExp("^"+l.join("$|^")+"$","i"),s=e.hasOwnProperty("levels")?e.levels:e.hasOwnProperty("level")?e.level:r.levels,Array.isArray(s)||(s=[s]),s=new RegExp("^"+s.join("$|^")+"$","i"),o=v(e),delete o.level,delete o.group,delete o.id,delete o.name,o.levels=s,o.groups=t,o.ids=l,o.names=n,o}},k=function(){var e;t=function(r){var t,n,l,s,o,a,i,p,u=[],d=this;for(s=(r=w(r)).peptides,a=r.exposures,o=r.cycles,t=0;t<s.length;t+=1)for(n=0;n<o.length;n+=1)for(l=0;l<a.length;l+=1)i=c[o[n]][a[l]],p=y[s[t]].index,void 0!==i&&void 0!==p&&u.push({peptide:s[t],cycle:o[n],exposure:a[l],spot_row:1*y[s[t]].row,spot_col:1*y[s[t]].col,image:e(i,d)});return u},e=function(e,r){var t;for(t=0;t<r.run_data.length;t+=1)if(r.run_data[t].key.match(/image/i))return r.run_data[t].value[e]},n=function(e){var r;return"string"!=typeof(e=e||"")&&(e="",console.warn("list should only be passed a string")),e.match(/peptide/i)?(r=v(u),r.more=O,r):e.match(/exposure/i)?v(d):e.match(/cycle/i)?v(p):(r={peptides:v(u),exposures:v(d),cycles:v(p)},r.peptides.more=O,r)},l=function(e){var r,t,n;for(p=[],c={},d=[],h={},u=[],y={},P(e),r=0;r<e.cycles.length;r+=1)null===(t=e.cycles[r])&&(t="Post Wash"),null===(n=e.exposures[r])&&(n="Cycle Slope"),c[t]=c[t]||[],c[t][n]=r,h[n]=1;p=Object.keys(c).map(m),d=Object.keys(h).map(m)}},O=function(){var e,r,t,n,l,s,o=[],a=this;for(e=0;e<a.length;e+=1){for(s=0,t=v(y[a[e]].full),r=0;s<2&&r<t.length;r+=1)t[r].key.match(/spotRow/i)?(n=parseInt(t[r].value,10),s+=1):t[r].key.match(/spotCol/i)&&(l=parseInt(t[r].value,10),s+=1);Object.defineProperty(t,"pos",{value:{spot_row:n,spot_col:l},enumerable:!1}),Object.defineProperty(t,"name",{value:a[e],enumerable:!1}),o.push(t)}return o},w=function(e){var r,t,n,l,s;if(e=e||{},r=e.hasOwnProperty("peptides")?e.peptides:e.hasOwnProperty("peptide")?e.peptide:u,t=e.hasOwnProperty("cycles")?e.cycles:e.hasOwnProperty("cycle")?e.cycle:void 0,n=e.hasOwnProperty("exposures")?e.exposures:e.hasOwnProperty("exposure")?e.exposure:void 0,void 0===t)for(t=v(p),l=0;l<t.length;l+=1)"Post Wash"===t[l]&&(t.splice(l,1),l-=1);if(void 0===n)for(n=v(d),l=0;l<n.length;l+=1)"Cycle Slope"===n[l]&&(n.splice(l,1),l-=1);for(r=Array.isArray(r)?r:[r],t=Array.isArray(t)?t:[t],n=Array.isArray(n)?n:[n],l=0;l<r.length;l+=1)y.hasOwnProperty(r[l])||r.splice(l,1);for(l=0;l<t.length;l+=1)c.hasOwnProperty(t[l])||t.splice(l,1);for(l=0;l<n.length;l+=1)h.hasOwnProperty(n[l])||n.splice(l,1);return s=v(e),s.cycles=t,s.exposures=n,s.peptides=r,delete s.cycle,delete s.exposure,delete s.peptide,s},b=function(e){var r,t=[];for(r=0;r<e;r+=1)t.push(void 0);return t},P=function(e){var r,t,n,l,s,o;for(r=0;r<e.peptides.length;r+=1){for(t=0;t<e.peptides[r].length;t+=1)"ID"===e.peptides[r][t].key&&(l=t),"spotRow"===e.peptides[r][t].key&&(n=t),"spotCol"===e.peptides[r][t].key&&(s=t);if("#REF"!==(o=e.peptides[r][l].value)){for(;y.hasOwnProperty(o);)o+="_2";u.push(o),y[o]={name:e.peptides[r][l].value,row:e.peptides[r][n].value,col:e.peptides[r][s].value,index:r,full:e.peptides[r]}}}},v=function(e){return JSON.parse(JSON.stringify(e))},a=function(){var r,t,n,l,s,o=this;for(r=v(o),t=Object.getOwnPropertyNames(o),n=Object.getOwnPropertyNames(r),l=0;l<t.length;l+=1)for(s=0;s<n.length;s+=1)if(t[l]===n[s]){t.splice(l,1),n.splice(s,1),l-=1;break}for(l=0;l<t.length;l+=1)"function"!=typeof o[t[l]]&&Object.defineProperty(r,t[l],{enumerable:!1,configurable:!1,writable:!1,value:o[t[l]]});return delete r._id,e.enrich(r)},m=function(e){return"string"==typeof e&&e.match(/Post\ Wash|Cycle\ Slope/i)?e:1*e},i=function(){var e=this.clone();delete e._id;for(var r,t,n,l=[e];l.length>0;)for(t=l.shift(),r=Object.keys(t),n=0;n<r.length;n+=1)"object"==typeof t[r[n]]&&null!==t[r[n]]?l.push(t[r[n]]):t[r[n]]&&"number"==typeof t[r[n]]&&(t[r[n]]=1*t[r[n]].toPrecision(6));return JSON.stringify(e)},Array.isArray(r)&&r.length>0?(r=r.map(function(r){return e.enrich(r)}),x(),Object.defineProperty(r,"clone",{value:a,enumerable:!1}),Object.defineProperty(r,"stringify",{value:i,enumerable:!1}),l(r),Object.defineProperty(r,"get",{value:t,enumerable:!1}),Object.defineProperty(r,"list",{value:n,enumerable:!1})):"object"==typeof r&&!Array.isArray(r)&&!r.hasOwnProperty("get")&&r.level&&r.level.match(/^1\.\d\.\d/)?(g(),Object.defineProperty(r,"clone",{value:a,enumerable:!1}),Object.defineProperty(r,"stringify",{value:i,enumerable:!1}),l(r),Object.defineProperty(r,"get",{value:t,enumerable:!1}),Object.defineProperty(r,"list",{value:n,enumerable:!1}),Object.defineProperty(r,"put",{value:s,enumerable:!1}),Object.defineProperty(r,"level_up",{value:o,enumerable:!1})):"object"==typeof r&&!Array.isArray(r)&&!r.hasOwnProperty("get")&&r.level&&r.level.match(/^2\.\d\.\d/)?(f(),Object.defineProperty(r,"clone",{value:a,enumerable:!1}),Object.defineProperty(r,"stringify",{value:i,enumerable:!1}),l(r),Object.defineProperty(r,"get",{value:t,enumerable:!1}),Object.defineProperty(r,"list",{value:n,enumerable:!1}),Object.defineProperty(r,"put",{value:s,enumerable:!1})):"object"==typeof r&&!Array.isArray(r)&&!r.hasOwnProperty("get")&&r.level&&r.level.match(/name/)&&(k(),Object.defineProperty(r,"clone",{value:a,enumerable:!1}),Object.defineProperty(r,"stringify",{value:i,enumerable:!1}),console.log("here..."),l(r),console.log("here...2"),Object.defineProperty(r,"get",{value:t,enumerable:!1}),Object.defineProperty(r,"list",{value:n,enumerable:!1})),r}}("undefined"!=typeof module&&module.exports?module.exports:KINOME);