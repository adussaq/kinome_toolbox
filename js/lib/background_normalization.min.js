!function(e){"use strict";var n,t,o,r=require("fit");r.hasOwnProperty("fit")?r=r.fit:r.then(function(){r=KINOME.fit});var a=function(){var e={};return function(n,t,o,a){return new Promise(function(i,u){setTimeout(function(){var c="linear"===t?n[0].name+n[0].cycle+n[0].peptide+o:n[0].name+n[0].exposure+n[0].peptide+o;e[c]||(e[c]=r(n,t,o)),e[c].then(function(e){e.passback=a,i(e)}).catch(function(e){u(e)})},250)})}}(),i=function(e,n,t,o,r){var i,u,c=[],s=e.get({cycle:n,peptide:o}),l=e.get({exposure:t,peptide:o});for(u=0,i=0;i<s.length;i+=1)u+=1*s[i][r+"_valid"];for(c[0]=u>1?a(s,"linear",r,t).then(function(e){return{R2:e[r].R2,val:e.equation.func([e.passback],e[r].parameters,e.equation.func([e.passback],e[r].parameters))}}):Promise.resolve({R2:0,val:0}),u=0,i=0;i<l.length;i+=1)u+=1*l[i][r+"_valid"];return c[1]=u>5?a(l,"kinetic",r,n).then(function(e){return{R2:e[r].R2,val:e.equation.func([e.passback],e[r].parameters),passback:e.passback,peptide:o}}):Promise.resolve({R2:0,val:0,peptide:o,cycle:n,exposure:t}),Promise.all(c).then(function(e){var n=0,t=0;return e[0].R2>.8&&!Number.isNaN(e[0].val)&&(n+=e[0].val*e[0].R2,t+=e[0].R2),e[1].R2>.8&&!Number.isNaN(e[1].val)&&(n+=e[1].val*e[1].R2,t+=e[1].R2),t>0&&(n/=t),n&&n<5500&&n>0?n:NaN})},u=function(e){var n,t,o=e[0],r=e[1],a=e[2];return n=o.spot_row-1,t=o.spot_col-1,{x:n,y:t,signal:a,background:r,name:o.peptide,cycle:o.cycle,exposure:o.exposure}};o=function(e,n){return function(t){if(!t.get||"function"!=typeof t.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";if("1.0.1"!==t.level)throw"This is designed only for level 1.0.1 data. You passed in level: "+t.level;var o,r,a,c,s,l,d,p,f,g=[],m=t.clone();m.level="1.1.2",r=m.list("cycles"),a=m.list("exposures"),c=function(e){var t,o=0;for(o=0;o<e.backgrounds.length;o+=1)(t=m.get({cycle:e.cycle,exposure:e.exposure,peptide:e.backgrounds[o].peptide})[0]).background_valid&&t.set("background",e.backgrounds[o].background);n.done+=1,n.done=Math.floor(n.done)};var h=function(e){var n={background:[],signal:[],name:[]};return e.map(function(e){n.background[e.x]=n.background[e.x]||[],n.signal[e.x]=n.signal[e.x]||[],n.name[e.x]=n.name[e.x]||[],n.cycle=e.cycle,n.exposure=e.exposure,n.background[e.x][e.y]=e.background,n.signal[e.x][e.y]=e.signal,n.name[e.x][e.y]=e.name}),n},b=function(n){if(n.background.length&&n.background[0].length)return e.submit(n).then(c)};for(s=0;s<r.length;s+=1)for(l=0;l<a.length;l+=1){for(o=m.get({cycle:r[s],exposure:a[l]}),f=[],d=0;d<o.length;d+=1)p=[Promise.resolve(o[d])],o[d].background_valid?p[1]=Promise.resolve(o[d].background):p[1]=i(t,r[s],a[l],o[d].peptide,"background"),o[d].background_valid?p[2]=Promise.resolve(o[d].signal):p[2]=i(t,r[s],a[l],o[d].peptide,"signal"),f.push(Promise.all(p).then(u));f.length&&(n.total+=1),g.push(Promise.all(f).then(h).then(b))}return Promise.all(g).then(function(){return m})}},t=function(e){var n,t,o,r,a,i,u,c=e.list("exposures");for(o=function(e){var n=1/0;return e.background_valid&&(n=Math.min(n,e.background)),e.signal_valid&&(n=Math.min(n,e.signal)),n},r=function(e,n){return"number"==typeof e&&"number"==typeof n?Math.min(e,n):"number"==typeof e?e:"number"==typeof n?n:1/0},i=e.list("cycles").reduce(r),n=0;n<c.length;n+=1)if((u=e.get({cycle:i,exposure:c[n]})).length>1)for(a=u.map(o).reduce(r),u=e.get({exposure:c[n]}),t=0;t<u.length;t+=1)u[t].set("signal",u[t].signal-a),u[t].set("background",u[t].background-a);return e},n=function(e){return new Promise(function(n,r){e.data&&"object"==typeof e.data||r("Data object not added in. This will not work without it."),e.amd_ww&&"object"==typeof e.amd_ww||r("AMD_WW object not added in. This will not work without it."),e.worker&&"string"==typeof e.worker||r("String for worker url not added in. This will not work without it."),Array.isArray(e.data)||(e.data=[e.data]);var a,i,u={total:0,done:0};i=e.number_threads||void 0,a=e.amd_ww.start({filename:e.worker,num_workers:i}),console.log("\nStarting fits for background normalization.\n"),Promise.all(e.data.map(o(a,u))).catch(function(e){r({message:"Background normalization failed:",error:e})}).then(function(e){e=e.map(t),n(e)}).catch(function(e){r(e)}),e.hasOwnProperty("update")&&"function"==typeof e.update&&e.update(u)})},e.normalize_background=n}("undefined"!=typeof module&&module.exports?module.exports:KINOME);