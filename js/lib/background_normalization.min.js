!function(e){"use strict";var n,t,o,a={total:0,done:0};o=function(e){return function(n){if(!n.get||"function"!=typeof n.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";if("1.0.1"!==n.level)throw"This is designed only for level 1.0.1 data. You passed in level: "+n.level;var t,o,r,i,u,l,d,s,c,g,f=[];for((n=n.clone()).level="1.1.2",o=n.list("cycles"),r=n.list("exposures"),i=function(e){var t=0;for(t=0;t<e.backgrounds.length;t+=1)n.get({cycle:e.cycle,exposure:e.exposure,peptide:e.backgrounds[t].peptide})[0].set("background",e.backgrounds[t].background);a.done+=1},u=0;u<o.length;u+=1)for(l=0;l<r.length;l+=1){for(t=n.get({cycle:o[u],exposure:r[l]}),s={background:[],signal:[],name:[],cycle:o[u],exposure:r[l]},d=0;d<t.length;d+=1)c=t[d].spot_row-1,g=t[d].spot_col-1,s.background[c]=s.background[c]||[],s.signal[c]=s.signal[c]||[],s.name[c]=s.name[c]||[],s.name[c][g]=t[d].peptide,t[d].background_valid?(s.background[c][g]=t[d].background,t[d].signal_valid?s.signal[c][g]=t[d].signal:s.signal[c][g]=NaN):(s.background[c][g]=NaN,s.signal[c][g]=NaN);a.total+=1,f.push(e.submit(s).then(i))}return Promise.all(f).then(function(){return n})}},t=function(e){var n,t,o,a,r,i,u,l=e.list("exposures");for(o=function(e){var n=1/0;return e.background_valid&&(n=Math.min(n,e.background)),e.signal_valid&&Math.min(n,e.signal),n},a=function(e,n){return"number"==typeof e&&"number"==typeof n?Math.min(e,n):"number"==typeof e?e:"number"==typeof n?n:1/0},i=e.list("cycles").reduce(a),n=0;n<l.length;n+=1)for(r=(u=e.get({cycle:i,exposure:l[n]})).map(o).reduce(a),u=e.get({exposure:l[n]}),t=0;t<u.length;t+=1)u[t].set("signal",u[t].signal-r),u[t].set("background",u[t].background-r);return e},n=function(e){return new Promise(function(n,r){e.data&&"object"==typeof e.data||r("Data object not added in. This will not work without it."),e.amd_ww&&"object"==typeof e.amd_ww||r("AMD_WW object not added in. This will not work without it."),e.worker&&"string"==typeof e.worker||r("String for worker url not added in. This will not work without it."),Array.isArray(e.data)||(e.data=[e.data]);var i,u,l;l=e.number_threads||void 0,u=e.amd_ww.start({filename:e.worker,num_workers:l}),console.log("\nStarting fits for background normalization.\n"),i=Promise.all(e.data.map(o(u))).catch(function(e){r({message:"Background normalization failed:",error:e})}),e.hasOwnProperty("update")&&"function"==typeof e.update&&e.update(a),i.then(function(e){e=e.map(t),n(e)}).catch(function(e){r(e)})})},e.normalize_background=n}("undefined"!=typeof module&&module.exports?module.exports:KINOME);