!function(e){"use strict";require("bs_slider-js"),require("bs_slider-css"),require("peptide_picker-css","css",!1),require("gradient");e.peptidePicker=function(e){var p,a,o={},t={},n={};o.peptideMatrixDummy=$("<div>").appendTo($('<div class="col-sm-6 col-md-5"></div>').appendTo($('<div class="container" style="height: 0px; visibility: hidden"></div>').appendTo("body"))),o.container=$('<div id="peptide-picker-container" class="container"></div>'),o.row=$('<div class="row"></div>').appendTo(o.container),o.peptidePickerCol=$('<div class="col-sm-6 col-md-5"></div>').appendTo(o.row),o.metaDataCol=$('<div id="metadata-col" class="col-sm-6 col-md-7 bottom-column"></div>').appendTo(o.row),o.cycleExposureRow=$('<div id="cycle-exposure-row" class="row"></div>').appendTo(o.metaDataCol),o.metaDataDisplay=$("<div>").appendTo(o.metaDataCol),o.gradientScale=void 0,o.dataTable=void 0;var i=function(e){return e.sample&&e.sample.clone||(e.sample={clone:function(){return null}}),{sample:e.sample.clone(),peptide:e.peptide,exposure:e.exposure,cycle:e.cycle,kinetic:{peptide:e.peptide,exposure:e.exposure},linear:{peptide:e.peptide,cycle:e.cycle}}};t.sample=t.sample||e[0],t.peptide=t.peptide||null,t.cycle=t.cycle||null,t.exposure=t.exposure||null,p=i(t);var l=function(){},c=function(e,a,o){(t.sample.name!==p.sample.name||t.peptide!==p.peptide||t.exposure!==p.exposure||t.cycle!==p.cycle||o)&&(l(i(t)),s(),p=i(t))},r=function(e,p){for(var a=[],o=0;o<e.length;o++)a.push("#191919");return Promise.resolve(a)},d=r,s=function(){var e;t.sample.level.match(/^1/i)?e=t.sample.get({cycle:t.cycle,exposure:t.exposure}):t.sample.level.match(/^2/i)&&(e={kinetic:t.sample.get({cycle:t.cycle,exposure:t.exposure,type:"kinetic"}),linear:t.sample.get({cycle:t.cycle,exposure:t.exposure,type:"linear"})}),(e.length||e.kinetic&&e.kinetic.length||e.linear&&e.linear.length?d(e,t):r(t.sample.list("peptide"))).then(function(e){!function(e){for(var p,o,t=0;t<a.length;t++)o=1*e[t],Number.isFinite(o)?(o=o>1?1:o<0?0:o,p=KINOME.gradient.convert(o)):p="#191919",a[t].changeSpotColor(p)}(e)}).catch(function(e){return console.warn("The peptide color function expects a promise",e),e})};o.gradientScale=KINOME.gradient.colorBar(10,150).hide();var u=function(e){return e?[{key:"Signal",value:e.signal},{key:"Background",value:e.background}]:[{key:"Signal",value:void 0},{key:"Background",value:void 0}]},h=u;n.div=o.container,n.change=function(e){"function"==typeof e?(l=e,c(i(t),0,!0)):console.error("The change function of peptide picker expects a function")},n.setState=function(e){var p,a;p=Object.keys(t);for(var o=0;o<p.length;o++)e[p[o]]!==t[p[o]]&&(t[p[o]]=e[p[o]],a=1);a&&l(t)},n.disableSample=function(){o.peptidePickerCol.children().children().children("select").prop("disabled",!0)},n.setColorFunc=function(e){"function"==typeof e?(d=e,s(),o.gradientScale.show()):(d=r,o.gradientScale.hide(),console.warn("The setColorFunc expects a function, not this",e))},n.setTable=function(e){"function"==typeof e?(h=customFunc,P(t.sample,t.peptide,t.cycle,t.exposure)):(h=u,console.warn("The setTable function requires a function argument, not this",e))};var m=function(e,p){for(var a=new RegExp(e,"i"),o=0;o<p.length;o++)k(p[o],!0).match(a)?p[o].changeSpotOpacity(1):p[o].changeSpotOpacity(.1)},v=function(){var e={};return function(p,a,o){o||(o="Don't call this twice without a uniqueId"),e[o]&&clearTimeout(e[o]),e[o]=setTimeout(p,a)}}(),f=function(e,p,a,o){var n=e[0].list("peptides").more(),i=0;return n=y(n,p),a.change(function(a){i=$(this).val(),n=e[i].list("peptides").more(),t.sample=e[i],c(),n=g(n,p)}),$(window).resize(function(e){v(function(){n=g(n,p)},500,"bleh bleh bleh <-- unique ID :D :P")}),o.keyup(function(e){var p=$(this).val();m(p,n)}),n},y=function(e,p){$('<label id="peptide-picker-label">Peptide: </label>').append(o.gradientScale).appendTo(o.peptideMatrix);var n,i,l,c,r,d,u=$('<div id="peptide-list"></div>').appendTo(o.peptideMatrix),h=0,v=(n=o.peptideMatrixDummy.width())/function(e){return e.reduce(function(e,p){return e.pos.spot_col>p.pos.spot_col?e:p}).pos.spot_col}(e),f=.65*v;n-=17;for(var y=0;y<e.length;y++){var g=e[y].pos.spot_row;g!==h&&(i=$('<div class="row-number-'+g+'"></div>').appendTo(u)),l=T(e[y],i,v,f),b(l,e[y]),e[y].name===t.peptide&&(c=e[y],x(e[y],c,e[y].defaultCellColor,!1)),function(p){l.click(function(a){d=x(e[p],c,e[p].defaultCellColor,!0),c=d[0],r=d[1]})}(y),h=g}return D(t.sample),null===t.peptide&&C(t.sample),m($("#peptide-search").val(),e),s(),a=e,e},g=function(e,p){return o.peptideMatrix.empty(),y(e,p)},T=function(e,p,a,o){var t;return e.defaultCellColor="#e7e7e7",t=$('<span class="microarray-sample" style="width: '+a+"px; height: "+a+"px; background-color: "+e.defaultCellColor+'"><button style="width: '+o+"px; height: "+o+'px;"></button></span>').appendTo(p),e.cell=t,e.changeSpotOpacity=function(e){this.cell.children("button").css({opacity:e})},e.changeSpotColor=function(e){this.cell.children("button").css({"background-color":e})},e.changeCellColor=function(e){this.cell.css({"background-color":e})},t},x=function(e,p,a,o){return void 0!==p&&p.changeCellColor(a),p&&e.name===p.name&&o?(t.peptide=null,c(),C(t.sample),a=e.defaultCellColor,e=void 0):(w(e),a=e.cell.css("background-color"),e.changeCellColor("#6c6c93")),[e,a]},b=function(e,p){o.container.attr("id");var a=window.innerWidth,t=p.name,n=$('<div class="tooltip">'+t+"</div>").appendTo("body"),i=n.width()+20;n.remove(),e.popover({content:p.name,placement:function(e,p){var o=$(p).offset().left+$(p).width();return i>a-o-45?"left":"right"},trigger:"hover",html:!0})},k=function(e,p){for(var a={name:e.name,sequence:null,phosph:{aminoAcid:null,pos:null},spotConc:null,uniprot:null,desc:null},o=e.name,t=0;t<e.length;t++)if(e[t].key.match(/sequence/i))a.sequence=e[t].value,o+=e[t].value;else if(e[t].key.match(/tyr/i)){try{a.phosph={aminoAcid:e[t].key,pos:JSON.parse(e[t].value)}}catch(p){a.phosph={aminoAcid:e[t].key,pos:e[t].value}}o+=e[t].key,o+=e[t].value}else e[t].key.match(/spotconcentration/i)?(a.spotConc=e[t].value,o+=e[t].value):e[t].key.match(/uniprotaccession/i)?(a.uniprot=e[t].value,o+=e[t].value):e[t].key.match(/description/i)&&(a.desc=e[t].value);return p?o:a},C=function(e){o.metaDataDisplay.empty();var p,a=$('<div id="sample-metadata"></div>').appendTo(o.metaDataDisplay),t=($('<h2 class="page-header">Sample Information</h2>').appendTo(a),$('<div class="row"></div>').appendTo(a)),n=$('<div class="col-xs-6"></div>').appendTo(t),i=$('<div class="col-xs-6"></div>').appendTo(t);$("<h3>Level</h3>").appendTo(n),$("<p>"+e.level+"</p>").appendTo(n),$("<h3>Barcode</h3>").appendTo(i),$("<p>"+e.name+"</p>").appendTo(i);for(var l=0;l<e.sample_data.length;l++)p=l%2==0?n:i,$("<h3>"+e.sample_data[l].key+"</h3>").appendTo(p),$("<p>"+e.sample_data[l].value+"</p>").appendTo(p);$('<p class="lead alert alert-info text-center" style="margin-top: 20px">Pick a peptide to display its specific information</p>').appendTo(a)},w=function(e){t.peptide=e.name,c(),D(t.sample),o.metaDataDisplay.empty();var p=k(e),a=$('<div class="metadata"></div>').appendTo(o.metaDataDisplay),n=($('<h2 class="page-header">Peptide Information</h2>').appendTo(a),$('<div class="row"></div>').appendTo(a)),i=$('<div class="col-xs-6"></div>').appendTo(n),l=$('<div class="col-xs-6"></div>').appendTo(n);!function(e,p){if(Array.isArray(e.phosph.pos)){for(var a=e.name.split("_"),o=a[a.length-2],t=e.sequence.split(""),n=0;n<e.phosph.pos.length;n++){var i=e.phosph.pos[n]-o;t[i]='<span style="color: '+p+'"><strong>'+t[i]+"</strong></span>"}e.sequence=t.join("")}else console.warn("Phosphorylation positions are not parsible")}(p,"#ffa500"),$("<h3>Name</h3>").appendTo(i),$("<p>"+p.name+"</p>").appendTo(i),$("<h3>Sequence</h3>").appendTo(l),$("<p>"+p.sequence+"</p>").appendTo(l),$("<h3>Phosphorylation</h3>").appendTo(i),$("<p>Amino Acid: "+p.phosph.aminoAcid+"</p>").appendTo(i),$("<p>Position: "+p.phosph.pos+"</p>").appendTo(i),$("<h3>Spot Concentration</h3>").appendTo(l),$("<p>"+p.spotConc+"</p>").appendTo(l),$("<h3>Uniprot Accession</h3>").appendTo(i),$('<p><a href="http://uniprot.org/uniprot/'+p.uniprot+'" target="_blank">'+p.uniprot+"</a></p>").appendTo(i),$("<h3>Description</h3>").appendTo(l),$("<p>"+p.desc.replace(/\([\s\S]+$/g,"")+"</p>").appendTo(l),P(t.sample,t.peptide,t.cycle,t.exposure)},D=function(e){o.cycleExposureRow.empty();var p=$('<div class="col-sm-6"></div>').appendTo(o.cycleExposureRow),a=$('<div class="col-sm-6"></div>').appendTo(o.cycleExposureRow);S(e,p,"cycle"),S(e,a,"exposure"),$("#peptide-metadata").append()},S=function(e,p,a){$('<h2 class="page-header">'+function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(a)+"</h2>").appendTo(p);for(var o=$('<div id="'+a+'-slider" class="sliders"></div>').appendTo(p),n=$('<input type="text" />'),i=e.list(a),l=i.length-1,r=0;r<i.length;r++)"exposure"===a&&null===t[a]&&50===i[r]?l=r:null!==t[a]&&t[a]===i[r]&&(l=r);n.appendTo(o),t[a]=i[l],c(),n.slider({value:l,min:0,max:i.length-1,tooltip_position:"bottom",tooltip:"always",formatter:function(e){return i[e]}}).on("slideStop",function(e){t[a]=i[e.value],c(),P(t.sample,t.peptide,t.cycle,t.exposure)})},P=function(e,p,a,t){if(void 0!==o.dataTable&&o.dataTable.empty(),o.dataTable=$("<div>"),p){var n,i=e.get({peptide:p,cycle:a,exposure:t})[0],l=o.dataTable,c=function(e,p,a,o){var t=e.get({peptide:p,cycle:a,exposure:o})[0];return void 0!==t&&void 0!==t.image?"./image/?img="+encodeURIComponent('"'+t.image+'"'):void 0}(e,p,a,t),r=[],d=[];(void 0!==c&&void 0!==i.image?$('<h3 style="display: inline; vertical-align: middle">Data</h3>&nbsp;&nbsp;&nbsp;&nbsp;<p style="display: inline;">(Image: <a href="'+c+'" target="_blank">'+i.image+"</a>)</p>"):$('<h3 style="display: inline; vertical-align: middle">Data</h3>')).appendTo(l),n=h(i);for(var s=0;s<n.length;s++)r.push(n[s].key),d.push(n[s].value);var u=$('<table class="table table-condensed"></table>').appendTo(l),m=$("<thead></thead>").appendTo(u),v=($("<tr><th>Measurement</th><th>Value</th></tr>").appendTo(m),$("<tbody>").appendTo(u));$("<tr><td>"+r.join(", ")+"</td><td>"+d.join(", ")+"</td></tr>").appendTo(v),i?$("<tr><td>Cycle, Exposure</td><td>"+i.cycle+", "+i.exposure+"</td></tr>").appendTo(v):$("<tr><td>Cycle, Exposure</td><td>"+a+", "+t+"</td></tr>").appendTo(v),l.appendTo(o.metaDataDisplay)}};return function(e){$('<h2 class="page-header">Peptide Picker</h2>').appendTo(o.peptidePickerCol);var p=$('<div class="row"></div>').appendTo(o.peptidePickerCol),a=$('<div class="col-sm-6"></div>').appendTo(p),n=$('<div class="col-sm-6 bottom-column"></div>').appendTo(p),i=($('<label for="sample-dropdown">Sample: </label>').appendTo(a),$('<select id="sample-dropdown" class="form-control"></select>').appendTo(a)),l=($('<label for="peptide-search">Peptide Search: </label>').appendTo(n),$('<input type="text" id="peptide-search" class="form-control" placeholder="regexp" />').appendTo(n));o.peptideMatrix=$('<div id="peptide-picker"></div>').appendTo(o.peptidePickerCol);for(var c=0;c<e.length;c++)t&&"object"==typeof t&&t.sample===e[c].name?i.append("<option selected value="+c+">"+e[c].name+"</option>"):i.append("<option value="+c+">"+e[c].name+"</option>");f(e,o.peptidePickerCol,i,l)}(e),n}}(KINOME);