!function(e){"use strict";var t,a,n,r,l,i,s,u,o,p,c,d,g,h,f;i=function(e){return function(t){return[c(t[e])]}},f=function(e){return"string"==typeof e?e.replace(/^[\s"']+|[\s"']+$/g,""):e};var m=function(e,t){var a=[];return Array.isArray(e)?a=a.concat(e):"string"==typeof e&&e.match(/^\s*$/)||a.push(e),Array.isArray(t)?a=a.concat(e):"string"==typeof t&&t.match(/^\s*$/)||a.push(t),a};d=function(){var e,t,a;for(e=1,t="";e<37;)a=15^e?8^Math.random()*(20^e?16:4):4,t+=51*e&52?a.toString(16):"-",e+=1;return t},u=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&Number.isNaN(e)&&Number.isNaN(t)?e:null},h=function(e){return"string"==typeof e&&e.match(/^NA$|^NAN$/im)?NaN:e},c=function(e){return"object"==typeof e?JSON.parse(JSON.stringify(e)):e},s=function(e){var t;return e=e.map(h),t=e.reduce(u),null!==t?t:e},a=function(e){return e.split("\t")},n=function(e,t){var a,n,p,g,h,m,y,v,k,_,b,N,x,w,$,O,j,A;a=e.shift().join(";").replace(/^[\s;]+|[\s;]+$/g,""),n=[],h=[],m={};do{n.push(e.shift())}while(!e[0][0]);for(k=e.shift(),b=(p=l(e,k)).data,_=p.peptides,g=r(n),y=0;y<g[0].length;y+=1)g[0][y].key.match(/^barcode$/i)&&(N=y),g[0][y].key.match(/^row$/i)&&(x=y);for(y=0;y<g.length;y+=1)if(w=g[y][N].value[0]+"_"+g[y][x].value[0],A=d(),m.hasOwnProperty(w)){for($=0;$<g[y].length;$+=1)m[w].meta[$].value=m[w].meta[$].value.concat(c(g[y][$].value));for($=0;$<b.length;$+=1)m[w].data[$].push(c(b[$][y]))}else m[w]={peptides:c(_),name:w,name_id:A,_id:A,meta:g[y],data:b.map(i(y))};for(O=Object.keys(m),y=0;y<O.length;y+=1){for(v=m[O[y]],$=0;$<v.meta.length;$+=1)v.meta[$].value=s(v.meta[$].value),(null===v.meta[$].value||"number"==typeof v.meta[$].value&&Number.isNaN(v.meta[$].value))&&(v.meta.splice($,1),$-=1);for(v.meta.push({key:"filename",value:f(t)}),v.meta.push({key:"title line",value:f(a)}),$=0;$<v.meta.length;$+=1)v.meta[$].key.match(/^cycle$/i)&&(v.cycles=c(v.meta[$].value.map(o))),v.meta[$].key.match(/^exposure[\s_]*time$/i)&&(v.exposures=c(v.meta[$].value.map(o)));for($=0;$<v.data.length;$+=1)j=v.data[$].reduce(u),Number.isNaN(j)&&(v.data.splice($,1),v.peptides.splice($,1),$-=1);h.push(v)}return h},r=function(e){var t,a,n,r,l;for(t=[],l=[],n=0;n<e.length;n+=1){for(;!e[n][0];)e[n].shift();l.push(e[n].shift())}for(n=0;n<e[0].length;n+=1){for(a=[],r=0;r<l.length;r+=1)a.push({key:f(l[r]),value:f([e[r][n]])});t.push(a)}return t},l=function(e,t){var a,n,r,l;for(r={peptides:[],data:[]},a=0;a<e.length;a+=1){for(l=[],n=0;e[a][0]&&e[a].length;)l.push({key:f(t[n]),value:f(e[a].shift())}),n+=1;for(r.peptides.push(l);!e[a][0]&&e[a].length;)e[a].shift();r.data.push(e[a].map(o))}return r},t=function(e){var t,r,l,i,s,u;if(t=e.signal.data.split(/[\r\n]+/).reduce(m).map(a),l=e.background.data.split(/[\r\n]+/).reduce(m).map(a),r=n(t,e.signal.filename),i=n(l,e.background.filename),!(s=p(r,i)))throw"failed to combine files, make sure all meta data is included and the files were exported at the same time with seperate data.";return(u=c(s)).map(function(e){return e.level="name",delete e.signal,delete e.background,delete e.signal_valid,delete e.background_valid,e}),s.map(function(e){return e.level="1.0.0",e}),{name:u,"1.0.0":s}},p=function(e,t){var a,n,r,l=[];r=function(e,t){for(var a,n,r,l,i=!0,s=[[e,t]];i&&s.length;)if(typeof(a=s.shift())[0]!=typeof a[1]&&(i=!1),"object"!=typeof a[0])a[0]!==a[1]&&(i=!1);else if(n=Object.keys(a[0]).sort(),r=Object.keys(a[1]).sort(),n.length!==r.length)i=!1;else for(l=0;l<n.length;l+=1)n[l]===r[l]?s.push([a[0][n[l]],a[1][r[l]]]):i=!1;return i},a=function(e,t){var a,l,i,s,u,o,p={},d=!0,h=[];for(p.meta=n(e.meta,t.meta),p.name=e.name,p.name_id=e.name_id,p._id=e.name_id,(p=g(p)).exposures=[],p.cycles=[],p.peptides=[],p.signal=[],p.background=[],p.signal_valid=[],p.background_valid=[],i=function(e,t){var a=e.key.toUpperCase(),n=t.key.toUpperCase();return a<n?-1:a>n?1:0},e.exposures.length===t.exposures.length&&e.cycles.length===t.cycles.length&&e.exposures.length===t.cycles.length&&e.peptides.length===t.peptides.length&&e.data.length===t.data.length&&e.data.length===t.peptides.length&&e.data[0].length===t.data[0].length&&e.data[0].length===t.cycles.length||(d=!1),a=0;d&&a<e.exposures.length;a+=1)for(d=!1,l=0;!d&&l<t.exposures.length;l+=1)e.exposures[a]===t.exposures[l]&&e.cycles[a]===t.cycles[l]&&(d=!0,p.exposures.push(e.exposures[a]),p.cycles.push(e.cycles[a]),h.push({fore:a,back:l}));for(a=0;d&&a<e.peptides.length;a+=1)for(d=!1,l=0;!d&&l<t.peptides.length;l+=1)if(r(e.peptides[a].sort(i),t.peptides[l].sort(i)))for(d=!0,p.peptides.push(e.peptides[a]),s=p.peptides.length-1,o=0;o<h.length;o+=1)p.signal[o]=p.signal[o]||[],p.background[o]=p.background[o]||[],p.signal_valid[o]=p.signal_valid[o]||[],p.background_valid[o]=p.background_valid[o]||[],p.signal[o][s]=e.data[a][h[o].fore],p.background[o][s]=t.data[l][h[o].back],p.signal_valid[o][s]=0,p.background_valid[o][s]=0,p.signal[o][s]<4095&&(p.signal_valid[o][s]=1),p.background[o][s]<4095&&(p.background_valid[o][s]=1);u=Math.max.apply(null,p.cycles),p.cycles=p.cycles.map(function(e){return e===u?null:e}),d||(p=!1);var f=p.peptides.map(function(e,t){return[e,t]}).sort(function(e,t){var a,n,r,l;return e[0].map(function(e){e.key.match(/spot[_\s]*row/i)&&(a=e.value),e.key.match(/spot[_\s]*col/i)&&(r=e.value)}),t[0].map(function(e){e.key.match(/spot[_\s]*row/i)&&(n=e.value),e.key.match(/spot[_\s]*col/i)&&(l=e.value)}),a===n?r-l:a-n}),m=c(p);for(l=0;l<f.length;l+=1){for(o=0;o<p.signal.length;o+=1)m.signal[o][l]=p.signal[o][f[l][1]],m.background[o][l]=p.background[o][f[l][1]],m.signal_valid[o][l]=p.signal_valid[o][f[l][1]],m.background_valid[o][l]=p.background_valid[o][f[l][1]];m.peptides[l]=p.peptides[f[l][1]]}return m},n=function(e,t){var a,n,l,i=[],s=[];for(a=0;a<e.length;a+=1){for(l=!1,n=0;!l&&n<t.length;n+=1)e[a].key===t[n].key&&(l=!0,s[n]=!0,r(e[a],t[n])?i.push(e[a]):(e[a].origin="signal",t[n].origin="background",i.push(e[a]),i.push(t[n])));l||(e[a].origin="signal",i.push(e[a]))}for(a=0;a<t.length;a+=1)s[a]||(t[a].origin="signal",i.push(t[a]));return i};var i,s,u,o=!0;for(i=0;o&&i<e.length;i+=1)for(o=!1,s=0;!o&&s<t.length;s+=1)e[i].name===t[s].name&&(u=a(e[i],t[s]))&&(o=!0,l.push(u));return o||(l=!1),l},o=function(e){return 1*e},g=function(e){var t,a,n,r,l=[],i=[];for(t=(t=["barcode","row","col","filter","image","temperature","instrument_type","instrument_unit","image_timestamp","lamp_power","lamp_refrence_power","pamchip_location","array","runData","gridid","grid_type","article_number","exposure_time","cycle","title_line","filename"]).map(function(e){return new RegExp("^"+e+"$","i")}),a=0;a<e.meta.length;a+=1){for(r=!1,n=0;!r&&n<t.length;n+=1)e.meta[a].key.replace(/\s+/g,"_").match(t[n])&&(l.push(c(e.meta[a])),r=!0);r||i.push(c(e.meta[a]))}return delete e.meta,e.sample_data=i,e.run_data=l,e},e.parse=t}("undefined"!=typeof module&&module.exports?module.exports:KINOME);