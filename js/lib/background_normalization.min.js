!function(e){"use strict";var n,t,o;o=function(e,n){return function(t){if(!t.get||"function"!=typeof t.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";if("1.0.1"!==t.level)throw"This is designed only for level 1.0.1 data. You passed in level: "+t.level;var o,a,r,i,u,l,d,s,c,g,f=[];for((t=t.clone()).level="1.1.2",a=t.list("cycles"),r=t.list("exposures"),i=function(e){var o=0;for(o=0;o<e.backgrounds.length;o+=1)t.get({cycle:e.cycle,exposure:e.exposure,peptide:e.backgrounds[o].peptide})[0].set("background",e.backgrounds[o].background);n.done+=1},u=0;u<a.length;u+=1)for(l=0;l<r.length;l+=1){for(o=t.get({cycle:a[u],exposure:r[l]}),s={background:[],signal:[],name:[],cycle:a[u],exposure:r[l]},d=0;d<o.length;d+=1)c=o[d].spot_row-1,g=o[d].spot_col-1,s.background[c]=s.background[c]||[],s.signal[c]=s.signal[c]||[],s.name[c]=s.name[c]||[],s.name[c][g]=o[d].peptide,o[d].background_valid?(s.background[c][g]=o[d].background,o[d].signal_valid?s.signal[c][g]=o[d].signal:s.signal[c][g]=NaN):(s.background[c][g]=NaN,s.signal[c][g]=NaN);s.background.length&&s.signal.length&&(n.total+=1,f.push(e.submit(s).then(i)))}return Promise.all(f).then(function(){return t})}},t=function(e){var n,t,o,a,r,i,u,l=e.list("exposures");for(o=function(e){var n=1/0;return e.background_valid&&(n=Math.min(n,e.background)),e.signal_valid&&Math.min(n,e.signal),n},a=function(e,n){return"number"==typeof e&&"number"==typeof n?Math.min(e,n):"number"==typeof e?e:"number"==typeof n?n:1/0},i=e.list("cycles").reduce(a),n=0;n<l.length;n+=1)if((u=e.get({cycle:i,exposure:l[n]})).length>1)for(r=u.map(o).reduce(a),u=e.get({exposure:l[n]}),t=0;t<u.length;t+=1)u[t].set("signal",u[t].signal-r),u[t].set("background",u[t].background-r);return e},n=function(e){return new Promise(function(n,a){e.data&&"object"==typeof e.data||a("Data object not added in. This will not work without it."),e.amd_ww&&"object"==typeof e.amd_ww||a("AMD_WW object not added in. This will not work without it."),e.worker&&"string"==typeof e.worker||a("String for worker url not added in. This will not work without it."),Array.isArray(e.data)||(e.data=[e.data]);var r,i,u,l={total:0,done:0};u=e.number_threads||void 0,i=e.amd_ww.start({filename:e.worker,num_workers:u}),console.log("\nStarting fits for background normalization.\n"),r=Promise.all(e.data.map(o(i,l))).catch(function(e){a({message:"Background normalization failed:",error:e})}),e.hasOwnProperty("update")&&"function"==typeof e.update&&e.update(l),r.then(function(e){e=e.map(t),n(e)}).catch(function(e){a(e)})})},e.normalize_background=n}("undefined"!=typeof module&&module.exports?module.exports:KINOME);