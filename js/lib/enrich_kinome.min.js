!function(e){"use strict";e.enrich=function(t){var r,n,l,a,s,i,o,p,c,u,y,d,h,g,f,m,v,b,O,P,k,w;return g=function(){var t,i,o,g;r=function(e){var r,n,l,a,s,p,u,d,h=[],g=this;for(a=(e=k(e)).peptides,p=e.exposures,s=e.cycles,r=0;r<a.length;r+=1)for(n=0;n<s.length;n+=1)for(l=0;l<p.length;l+=1)u=c[s[n]][p[l]],d=y[a[r]].index,void 0!==u&&void 0!==d&&h.push({peptide:a[r],cycle:s[n],exposure:p[l],signal:g.signal[u][d],signal_valid:g.signal_valid[u][d],background:g.background[u][d],background_valid:g.background_valid[u][d],spot_row:1*y[a[r]].row,spot_col:1*y[a[r]].col,image:o(u,g),set:t(u,d,g),more:i(u,y[a[r]])});return h},i=function(e,t){return function(){return{peptide:m(t),image_index:e}}},o=function(e,t){var r;for(r=0;r<t.run_data.length;r+=1)if(t.run_data[r].key.match(/image/i))return t.run_data[r].value[e]},a=function(e){var t,r,n,a,s,i,o,p,c=this;if(g(e)){if(t=e.value,r=e.valid,n=e.type,a=e.peptide,i=e.cycle,s=e.exposure,s=null===s?"Cycle Slope":s,i=null===i?"Post Wash":i,1!==(p=c.get({peptide:a,cycle:i,exposure:s})).length){for(c.signal.push(b(c[n][0].length)),c.signal_valid.push(b(c[n][0].length)),c.background.push(b(c[n][0].length)),c.background_valid.push(b(c[n][0].length)),c.cycles.push("string"==typeof i?null:i),c.exposures.push("string"==typeof s?null:s),o=0;o<c.run_data.length;o+=1)Array.isArray(c.run_data[o].value)&&c.run_data[o].value.length===c.cycles.length-1&&c.run_data[o].value.push(void 0);l(c),p=c.get({peptide:a,cycle:i,exposure:s})}return p[0].set(n,t),p[0].set(n+"_valid",r),!0}return console.error("Failed to set, one or more parameters were missing or invalid."),!1},g=function(e){var t=!1;return e&&e.hasOwnProperty("value")&&e.hasOwnProperty("valid")&&e.hasOwnProperty("type")&&e.hasOwnProperty("peptide")&&e.hasOwnProperty("cycle")&&e.hasOwnProperty("exposure")&&(e.value*=1,e.valid*=1,e.cycle=null===e.cycle?null:"Post Wash"===e.cycle?null:1*e.cycle,e.exposure=null===e.exposure?null:"Cycle Slope"===e.exposure?null:1*e.exposure,isNaN(e.value)||isNaN(e.valid)||isNaN(e.cycle)||isNaN(e.exposure)||"string"!=typeof e.type||"string"!=typeof e.peptide||y.hasOwnProperty(e.peptide)&&e.type.match(/background|signal/)&&(t=!0)),t},t=function(e,t,r){return function(n,l){var a=this;n.match(/^(signal|background)(_valid)*$/)&&(r[n][e][t]=l,a[n]=l)}},n=function(e){var t;return(e=e||"").match(/peptide/i)?(t=m(u),t.more=O,t):e.match(/exposure/i)?m(d):e.match(/cycle/i)?m(p):(t={peptides:m(u),exposures:m(d),cycles:m(p)},t.peptides.more=O,t)},l=function(e){var t,r,n;for(p=[],c={},d=[],h={},u=[],y={},P(e),t=0;t<e.cycles.length;t+=1)null===(r=e.cycles[t])&&(r="Post Wash"),null===(n=e.exposures[t])&&(n="Cycle Slope"),c[r]=c[r]||[],c[r][n]=t,h[n]=1;p=Object.keys(c).map(v),d=Object.keys(h).map(v)},s=function(t){var r,n,l,a=this;for(l=(n=JSON.parse(a.stringify())).cycles.length,delete n.cycles,delete n.exposures,delete n.background,delete n.background_valid,delete n.signal,delete n.signal_valid,delete n._id,"string"!=typeof t&&console.error("No equation string passed in, please pass in a string with the needed parts. Example: https://github.com/adussaq/kinome_toolbox/blob/master/models/cyclingEq_3p_hyperbolic.jseq"),n.linear={signal:[],background:[],cycles:[]},n.kinetic={signal:[],background:[],exposures:[],equation_string:t},n.level=n.level.replace(/^1/,"2"),console.warn("delete this part once updated the data struct"),r=0;r<n.run_data.length;r+=1)if(n.run_data[r].key.match(/^cycle$/i)){l=n.run_data[r].value.length;break}for(r=0;r<n.run_data.length;r+=1)n.run_data[r].value.length===l&&(n.run_data.splice(r,1),r-=1);for(r=0;r<n.sample_data.length;r+=1)n.sample_data[r].value.length===l&&(n.sample_data.splice(r,1),r-=1);return e.enrich(n)}},f=function(){var e,t,s,i=["kinetic","linear"];a=function(e){var r,n,a,s,i,o,p,c=this;return t(e)?(r=e.value,n=e.peptide,s=e.cycle,a=e.exposure,o=e.type,p=e.signal_type,1!==(i=c.get({peptide:n,type:o,cycle:s,exposure:a})).length&&("kinetic"===o?(c.kinetic.signal.push(b(c.peptides.length)),c.kinetic.background.push(b(c.peptides.length)),c.kinetic.exposures.push("string"==typeof a?null:a)):"linear"===o&&(c.linear.signal.push(b(c.peptides.length)),c.linear.background.push(b(c.peptides.length)),c.linear.cycles.push("string"==typeof s?null:s)),l(c),i=c.get({peptide:n,type:o,cycle:s,exposure:a})),i[0].set(p,r),!0):(console.error("Failed to set, one or more parameters were missing or invalid."),!1)},e=function(e,t,r,n){return function(l,a){var s=this;"string"==typeof l&&(l=l.toLowerCase()).match(/^signal$|^background$/)?(n[e][l][t][r]=a,s[l]=a):console.error("failed to set, key invalid")}},s=function(e,t){return function(){return{peptide:m(t),fit_index:e}}},r=function(t){var r,n,l,a,o,p,u,d,g,f,v,b,O,P,w=this,x={},_=[];for(r=(t=k(t)).peptides,l=t.exposures,n=t.cycles,"string"==typeof(a=t.hasOwnProperty("type")?t.type:t.hasOwnProperty("types")?t.types:i)&&a.match(/kinetic|linear/i)?a=[a.toLowerCase()]:Array.isArray(a)&&a.map(function(e,t){return a[t]=a[t].toLowerCase(),e.match(/kinetic|linear/)?1:0}).reduce(function(e,t){return e*t})||(a=i),o=0;o<a.length;o+=1)for("kinetic"===a[o]?(d=l,f=h,g="exposure",v="cycle",b=n):(d=n,f=c,g="cycle",v="exposure",b=l),p=0;p<d.length;p+=1)for(u=0;u<r.length;u+=1)O=f[d[p]],P=y[r[u]].index,(x={peptide:r[u],type:a[o],signal:w[a[o]].signal[O][P],background:w[a[o]].background[O][P],spot_row:1*y[r[u]].row,spot_col:1*y[r[u]].col,set:e(a[o],O,P,w),more:s(O,y[r[u]])})[g]=d[p],x[v]=m(b),_.push(x);return _},l=function(e){var t,r,n;for(p=[],c={},d=[],h={},u=[],y={},P(e),t=0;t<e.linear.cycles.length;t+=1)null===(r=e.linear.cycles[t])&&(r="Post Wash"),c[r]=t;for(t=0;t<e.kinetic.exposures.length;t+=1)null===(n=e.kinetic.exposures[t])&&(n="Cycle Slope"),h[n]=t;p=Object.keys(c).map(v),d=Object.keys(h).map(v)},t=function(e){var t,r,n=!1;return e=e||{},e.exposure=null===e.exposure?"Cycle Slope":e.exposure,e.cycle=null===e.cycle?"Post Wash":e.cycle,e.hasOwnProperty("signal")&&!e.hasOwnProperty("background")?(t=e.signal,r="signal"):!e.hasOwnProperty("signal")&&e.hasOwnProperty("background")&&(t=e.background,r="background"),r&&"string"==typeof e.type&&e.type.match(/^linear$|^kinetic$/)&&"string"==typeof e.peptide&&y.hasOwnProperty(e.peptide)&&("linear"!==e.type||"number"!=typeof e.cycle&&"Post Wash"!==e.cycle?"number"!=typeof e.exposure&&"Cycle Slope"!==e.exposure||(n=!0):n=!0),e.signal_type=r,e.value=t,n},n=function(e){var t;return(e=e||"").match(/peptide/i)?(t=m(u),t.more=O,t):e.match(/exposure/i)?m(d):e.match(/cycle/i)?m(p):e.match(/type/i)?m(i):(t={peptides:m(u),exposures:m(d),cycles:m(p),types:m(i)},t.peptides.more=O,t)}},w=function(){var e,t,a,s,i;l=function(r){var n={},l={},s={},o={};y={},c={},h={},r.map(function(e){e.list("peptide").map(function(e){y[e]=1}),e.list("cycle").map(function(e){c[e]=1}),e.list("exposure").map(function(e){h[e]=1}),n[e.group]=1,l[e.name]=1,s[e.name_id]=1,o[e.level]=1}),u=Object.keys(y),p=Object.keys(c).map(v),d=Object.keys(h).map(v),e=Object.keys(n).map(v),t=Object.keys(l),a=Object.keys(s),i=Object.keys(o)},r=function(e){var t,r=this,n=[];for(e=s(k(e)),t=0;t<r.length;t+=1)r[t].name.match(e.names)&&r[t].group.toString().match(e.groups)&&r[t].level.match(e.levels)&&r[t].name_id.match(e.ids)&&(n=n.concat(r[t].get(e)));return n},n=function(r){return(r=r||"").match(/^names*$/i)?m(t):r.match(/^groups*$/i)?m(e):r.match(/^ids*$/i)?m(a):r.match(/^levels*$/i)?m(i):r.match(/^cycles*$/i)?m(p):r.match(/^exposures*$/i)?m(d):r.match(/^peptides*$/i)?m(u):(console.log(p),m({names:t,groups:e,ids:a,levels:i,cycles:p,exposures:d,peptides:u}))},s=function(r){var n,l,s,o,p;return n=r.hasOwnProperty("groups")?r.groups:r.hasOwnProperty("group")?r.group:e,Array.isArray(n)||(n=[n]),n=new RegExp("^"+n.join("$|^")+"$","i"),l=r.hasOwnProperty("names")?r.names:r.hasOwnProperty("name")?r.name:t,Array.isArray(l)||(l=[l]),l=new RegExp("^"+l.join("$|^")+"$","i"),s=r.hasOwnProperty("ids")?r.ids:r.hasOwnProperty("id")?r.id:a,Array.isArray(s)||(s=[s]),s=new RegExp("^"+s.join("$|^")+"$","i"),o=r.hasOwnProperty("levels")?r.levels:r.hasOwnProperty("level")?r.level:i,Array.isArray(o)||(o=[o]),o=new RegExp("^"+o.join("$|^")+"$","i"),p=m(r),delete p.level,delete p.group,delete p.id,delete p.name,p.levels=o,p.groups=n,p.ids=s,p.names=l,p}},O=function(){var e,t,r,n,l,a,s=[],i=this;for(e=0;e<i.length;e+=1){for(a=0,r=m(y[i[e]].full),t=0;a<2&&t<r.length;t+=1)r[t].key.match(/spotRow/i)?(n=parseInt(r[t].value,10),a+=1):r[t].key.match(/spotCol/i)&&(l=parseInt(r[t].value,10),a+=1);Object.defineProperty(r,"pos",{value:{spot_row:n,spot_col:l},enumerable:!1}),Object.defineProperty(r,"name",{value:i[e],enumerable:!1}),s.push(r)}return s},k=function(e){var t,r,n,l,a;if(e=e||{},t=e.hasOwnProperty("peptides")?e.peptides:e.hasOwnProperty("peptide")?e.peptide:u,r=e.hasOwnProperty("cycles")?e.cycles:e.hasOwnProperty("cycle")?e.cycle:void 0,n=e.hasOwnProperty("exposures")?e.exposures:e.hasOwnProperty("exposure")?e.exposure:void 0,void 0===r)for(r=m(p),l=0;l<r.length;l+=1)"Post Wash"===r[l]&&(r.splice(l,1),l-=1);if(void 0===n)for(n=m(d),l=0;l<n.length;l+=1)"Cycle Slope"===n[l]&&(n.splice(l,1),l-=1);for(t=Array.isArray(t)?t:[t],r=Array.isArray(r)?r:[r],n=Array.isArray(n)?n:[n],l=0;l<t.length;l+=1)y.hasOwnProperty(t[l])||t.splice(l,1);for(l=0;l<r.length;l+=1)c.hasOwnProperty(r[l])||r.splice(l,1);for(l=0;l<n.length;l+=1)h.hasOwnProperty(n[l])||n.splice(l,1);return a=m(e),a.cycles=r,a.exposures=n,a.peptides=t,delete a.cycle,delete a.exposure,delete a.peptide,a},b=function(e){var t,r=[];for(t=0;t<e;t+=1)r.push(void 0);return r},P=function(e){var t,r,n,l,a,s;for(t=0;t<e.peptides.length;t+=1){for(r=0;r<e.peptides[t].length;r+=1)"ID"===e.peptides[t][r].key&&(l=r),"spotRow"===e.peptides[t][r].key&&(n=r),"spotCol"===e.peptides[t][r].key&&(a=r);if("#REF"!==(s=e.peptides[t][l].value)){for(;y.hasOwnProperty(s);)s+="_2";u.push(s),y[s]={name:e.peptides[t][l].value,row:e.peptides[t][n].value,col:e.peptides[t][a].value,index:t,full:e.peptides[t]}}}},m=function(e){return JSON.parse(JSON.stringify(e))},i=function(){var t,r,n,l,a,s=this;for(t=m(s),r=Object.getOwnPropertyNames(s),n=Object.getOwnPropertyNames(t),l=0;l<r.length;l+=1)for(a=0;a<n.length;a+=1)if(r[l]===n[a]){r.splice(l,1),n.splice(a,1),l-=1;break}for(l=0;l<r.length;l+=1)"function"!=typeof s[r[l]]&&Object.defineProperty(t,r[l],{enumerable:!1,configurable:!1,writable:!1,value:s[r[l]]});return delete t._id,e.enrich(t)},v=function(e){return e.match(/Post\ Wash|Cycle\ Slope/i)?e:1*e},o=function(){var e=this.clone();delete e._id;for(var t,r,n,l=[e];l.length>0;)for(r=l.shift(),t=Object.keys(r),n=0;n<t.length;n+=1)"object"==typeof r[t[n]]&&null!==r[t[n]]?l.push(r[t[n]]):r[t[n]]&&"number"==typeof r[t[n]]&&(r[t[n]]=1*r[t[n]].toPrecision(6));return JSON.stringify(e)},Array.isArray(t)?(t=t.map(function(t){return e.enrich(t)}),w(),Object.defineProperty(t,"clone",{value:i,enumerable:!1}),Object.defineProperty(t,"stringify",{value:o,enumerable:!1}),l(t),Object.defineProperty(t,"get",{value:r,enumerable:!1}),Object.defineProperty(t,"list",{value:n,enumerable:!1})):!t.hasOwnProperty("get")&&t.level.match(/^1\.\d\.\d/)?(g(),Object.defineProperty(t,"clone",{value:i,enumerable:!1}),Object.defineProperty(t,"stringify",{value:o,enumerable:!1}),l(t),Object.defineProperty(t,"get",{value:r,enumerable:!1}),Object.defineProperty(t,"list",{value:n,enumerable:!1}),Object.defineProperty(t,"put",{value:a,enumerable:!1}),Object.defineProperty(t,"level_up",{value:s,enumerable:!1})):!t.hasOwnProperty("get")&&t.level.match(/^2\.\d\.\d/)&&(f(),Object.defineProperty(t,"clone",{value:i,enumerable:!1}),Object.defineProperty(t,"stringify",{value:o,enumerable:!1}),l(t),Object.defineProperty(t,"get",{value:r,enumerable:!1}),Object.defineProperty(t,"list",{value:n,enumerable:!1}),Object.defineProperty(t,"put",{value:a,enumerable:!1})),t}}("undefined"!=typeof module&&module.exports?module.exports:KINOME);